$workDir = "C:\Sources\ImportCVE"
$excelFile = "$workDir\SecurityUpdates.xlsx"

#region Download excel-file
$urlPage = 'https://portal.msrc.microsoft.com/api/security-guidance/en-us/excel'
$header = @{
"Accept"="application/json"
"Content-Type"="application/json"
}

$fromPublishedDate = (Get-Date).AddDays(-60).ToString("MM-dd-yyyy").Replace('-','/')
$toPublishedDate = (Get-Date).ToString("MM-dd-yyyy").Replace('-','/')
$body = @{
"includeCveNumber"="true"
"includeSeverity"="true"
"includeImpact"="true"
"orderBy"="publishedDate"
"fromPublishedDate"="$fromPublishedDate"
"toPublishedDate"="$toPublishedDate"
} | ConvertTo-Json

[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
Invoke-WebRequest -Uri $urlPage -Method POST -Body $body -Headers $header -OutFile $excelFile -UseBasicParsing
# $proxyUrl = 'http://proxy-server:8080'
# Invoke-WebRequest -Uri $urlPage -Method POST -Body $body -Headers $header -OutFile $excelFile -UseBasicParsing -Proxy $proxyUrl -ProxyUseDefaultCredentials
#endregion Download excel-file

#region Import from excel-file
Import-Module "$workDir\importexcel.6.5.1\ImportExcel.psd1" -Force
$excelData = Import-Excel -Path $excelFile
#endregion Import from excel-file

#region Export to sql database
$ServerInstance = "SCCM-SERVER"
$datebase = "CM_FOO"

foreach ($item in $excelData ) {
# Setting the values as variables first, also converting to correct format to match SQL DB
$ReleaseDate = $item.Date -as [datetime]
$Product = $item.Product
$ProductFamily = $item.'Product Family'
$Platform = $item.Platform
$Article = $($item.Article) -replace("'","") #The value may be with an apostrophe
$UpdateClassification = $item.Download
$Severity = $item.Severity
$Impact = $item.Impact
$CVE = $item.Details
# Creating the INSERT query using the variables defined
$SQLQuery = "USE $datebase
IF NOT EXISTS(
    SELECT *
    FROM Custom_CveArticleDependencies
    WHERE ReleaseDate = '$ReleaseDate' 
        AND Product = '$Product'
        AND ProductFamily = '$ProductFamily'
        AND Platform = '$Platform'
        AND Article = '$Article'
        AND UpdateClassification = '$UpdateClassification'
        AND Severity = '$Severity'
        AND Impact = '$Impact'
        AND CVE = '$CVE'
    )
BEGIN
    INSERT INTO Custom_CveArticleDependencies (ReleaseDate, Product, ProductFamily, Platform, Article, UpdateClassification, Severity, Impact, CVE)
    VALUES('$ReleaseDate','$Product','$ProductFamily','$Platform','$Article','$UpdateClassification','$Severity','$Impact','$CVE');
END
"
# Running the INSERT query
$SQLQueryOutput = Invoke-Sqlcmd -query $SQLQuery -ServerInstance $ServerInstance
}
#endregion Export to sql database